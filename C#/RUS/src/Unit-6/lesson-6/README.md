# Урок 6: Гарантированная доставка.

Канал гарантированной доставки - это канал вида «точка-точка», гарантирующии? доставку сообщения получателю. Это означает, что доставка будет выполнена, даже если при этом возникнут любые мыслимые ошибки. Канал должен иметь разнообразные механизмы и проверки, чтобы гарантировать доставку; например, сообщение должно сохраняться на диске на случай аварийного завершения системы. Всегда ли при создании систем нужен канал гарантированной доставки? Можно ли создать высоконадежную систему, не гарантируя доставки сообщений в ней. Да, вам нужны определённые гарантии, но гарантии максимальной доступности нужны далеко не всегда.

Фактически реализация канала гарантированной доставки не может гарантировать доставку во всех возможных ситуациях, например, когда в момент отправки сообщения возникает авария. В такой ситуации невозможно отправить сообщение, потому что оно исчезло вместе с отправителем. Вы постоянно должны задавать себе вопрос: достаточен ли уровень гарантий для моих целей?

Создавая систему, вы должны знать, какие гарантии даёт канал и достаточно ли их для вашей системы. Давайте посмотрим, какие гарантии даёт платформа Proto.Actor.

Главное правило доставки сообщений: сообщение должно быть доставлено не более одного раза. Это означает, что Proto.Actor обещает доставить сообщение только один раз или не доставить его вовсе, если оно будет потеряно. Это качество не особенно хорошо подходит для надёжных систем. Почему в Proto.Actor отсутствует реализация с полной гарантией доставки? Первая причина в том, что полная гарантия доставки сопряжена с большим количеством сложностей и требует множества накладных расходов. Это ухудшает производительность, даже когда вам не нужны полные гарантии доставки.

Во-вторых, никому не нужна просто надёжная доставка. Нам нужно знать, был ли обработан запрос, для чего требуется отправка подтверждающего сообщения. Это невозможно реализовать на уровне платформы Proto.Actor, потому что многое зависит от конкретной системы. И последняя причина, почему Proto.Actor не реализует полностью гарантированную доставку, - потому что поверх базовых гарантий всегда можно наложить более строгие гарантии. Но обратное невозможно: нельзя сделать строгую систему менее строгой, не изменив её ядра.

Фреймворк Proto.Actor не гарантирует точно одну доставку сообщения при любых условиях. Фактически дать такую гарантию не сможет ни одна система. Но она реализует базовое правило доставки сообщений локальным и удалённым акторам. Взглянув на эти две ситуации в отдельности, можно увидеть, что Proto.Actor действует не так плохо, как могло бы показаться.

Отправка локальных сообщений вообще почти не терпит неудач, потому что это самый обычный вызов метода. Неудача может быть обусловлена только чем-то катастрофическим, случившимся в недрах системы, например **StackOverflowError**, **OutOfMemoryError** или нарушением прав доступа к памяти. Во всех этих случаях актор физически не будет иметь возможности обработать сообщение. Поэтому гарантии доставки сообщений локальным акторам достаточно высоки.

Потеря сообщений действительно может стать проблемои? при использовании удаленных акторов. Неудачи доставки сообщений удаленным акторам более вероятны, особенно если они разделены ненадежными сетями. Если кто-то выдернет кабель Ethernet или выключит питание маршрутизатора, сообщение будет потеряно. Для решения этой проблемы Proto.Actor использует библиотеку **gRPC**.

**gRPC** — это высокопроизводительный фреймворк разработанный компанией Google для вызов удаленных процедур (RPC), работает поверх HTTP/2.

gRPC простой в использовании, отлично подходит для создания распределенных систем (микросервисов) и API. Имеет встроенную поддержку для балансировки нагрузки, трассировки, аутентификации и проверки жизнеспособности сервисов. Есть возможность создавать клиентские библиотеки для работы с бэкендом на 10 языках. Высокая производительность достигается за счет использования протокола HTTP/2 и Protocol Buffers.