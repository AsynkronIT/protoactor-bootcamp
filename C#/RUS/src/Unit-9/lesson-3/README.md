# Урок 3:  Снимки состояний.

При разработке реальных приложений, вы можем столкнуться с тем что, некоторые акторы будут генерировать чересчур много событий. Что в свою очередь, может привести к созданию очень длинноного журнала событий, что приведёт к длительному времени восстановления актора. 

Иногда более правильным подходом может быть разделение актора на несколько акторов. Однако, если это решение не приемлемо, вы можете использовать снимки состояния, чтобы значительно сократить время восстановления актора.

Persistent actors обычно сохраняют снимок состояния каждые n событий. Или при выполнении заданного условия.

При срабатывании условия для сохранения снимка состояния, обработка входящих сообщений приостанавливается до тех пор, пока снимок состояния не будет сохранен. Это означает, что состояние может быть безопасно сохранено.

Во время восстановления состояния persistent actor использует последний сохраненный снимок состояния для инициализации. После того как снимок состояния был загружен, начинается загрузка и обработка событий, которые идут после последнего сохранённого снимка состояния. Для того, что бы восстановления актор до его текущего (то есть последнего) состояния.

#### Удаление снимка состояния.

Чтобы освободить место в хранилище, Persistent actor, может удалять старые снимки, основываясь на индексе этого снимка. Для этого достаточно вызвать метод `DeleteSnapshotsAsync()` и передать ему индекс не нужного состояния.

#### Удаление события.

Обычно в приложениях удаление событий, не используется вовсе, либо используется в сочетании со снимками. Так как, удаляя события, вы теряете историю того, как изменялось состояние актора до того, как он достиг текущего состояния. Но всё же, если вам понадобится по какой-либо причине удалить события, вы можете воспользоваться методом `DeleteEventsAsync()` передав данному методу, индекс необходимого события.

#### Практическая реализация.

Давайте рассмотрим на практике, как мы можем использовать снимки состояния в нашей системе акторов. Для этого, немного перепишем пример из прошлого урока, для того, что бы он поддерживал работу со снимками состояний. Все что нам нужно для этого сделать это изменить конструктор нашего калькулятора заменив вызов метода `WithEventSourcing()` на метод `WithEventSourcingAndSnapshotting()` Отличие данных методов заключается в том что метод `WithEventSourcingAndSnapshotting()` не только сохраняет события, но и делает периодические снимки состояний согласно указанному предикату.

```c#
public Calculator(IProvider provider)
{
    _persistence = Persistence.WithEventSourcingAndSnapshotting(
    provider,
    provider,
    "demo-app-id",
    ApplyEvent,
    ApplySnapshot,
    new IntervalStrategy(2), () => _result);
}
```

Далее нам так же понадобится добавить метод ApplySnapshot()в наш класс. Для того что бы наш актор мог восстановить своё состояние из снимка.

```c#
private void ApplySnapshot(Snapshot snapshot)
{
    switch (snapshot)
    {
        case RecoverSnapshot msg:
            if (msg.State is double ss)
            {
                _result = ss;
                Console.WriteLine("MyPersistenceActor - RecoverSnapshot = Snapshot.Index = {0}, Snapshot.State = {1}", _persistence.Index, ss);
            }
            break;
    }
}
```

